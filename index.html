<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>TiffyAI AR Shooter</title>
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@1.0.0/dist/aframe-particle-system-component.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
  body, html { margin:0; padding:0; height:100%; overflow:hidden; background:black; font-family: 'Share Tech Mono', monospace; }
  #score {
    position:absolute; bottom:10px; left:10px; /* Positioned at bottom-left */
    color:#00f0ff; font-size:16px; font-family: 'Share Tech Mono', monospace;
    z-index:10000; /* Higher z-index to be on top */
    background: rgba(0,0,0,0.2); padding:8px 15px; border-radius:10px;
    backdrop-filter: blur(6px);
    display: flex;
    align-items: center;
  }
  #score img {
    height: 24px;
    margin-right: 8px;
  }
</style>
</head>
<body>
<div id="score"><img src="https://tiffyai.github.io/TiffyAI-Token.png" alt="TiffyAI Token">TIFFY Earnings: 0.000000</div>

<a-scene vr-mode-ui="enabled: true">

    <a-assets>
                <video id="background360" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/main/assets/right.mp4"></video>
        <video id="enemyVideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/enemies.mp4"></video>

        <audio id="shootSound" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/fire.wav"></audio>
        <audio id="explodeSound" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/blocks.wav"></audio>
        <audio id="swoochSound" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/swooch.wav"></audio>
        <audio id="bgMusic" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/playing.wav" crossorigin="anonymous"></audio>
    </a-assets>

    <a-sky src="#background360"></a-sky>

    <a-entity id="player" camera look-controls wasd-controls position="0 1.6 0"></a-entity>

    <a-entity id="cursor" cursor="fuse: false; rayOrigin: mouse"
            position="0 0 -1"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: #00ffff; shader: flat"
            animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 400"
            raycaster="objects: .enemy; far: 200"></a-entity>

    <a-entity id="effects-parent"></a-entity>

</a-scene>

<script>
/* ---------- Custom A-Frame Component for Visual Shot Movement ---------- */
AFRAME.registerComponent('visual-shot', {
    schema: {
        direction: {type: 'vec3'},
        speed: {type: 'number', default: 150},
    },
    tick: function(time, timeDelta) {
        const moveVector = this.data.direction.clone().multiplyScalar(this.data.speed * timeDelta / 1000);
        this.el.object3D.position.add(moveVector);
        const cameraPos = document.getElementById('player').object3D.position;
        if (this.el.object3D.position.distanceTo(cameraPos) > 200) {
            this.el.parentNode.removeChild(this.el);
        }
    }
});


/* ---------- Game Globals ---------- */
const scene = document.querySelector('a-scene');
const camera = document.getElementById('player');
const cursor = document.getElementById('cursor');
const effectsParent = document.getElementById('effects-parent');
const scoreEl = document.getElementById('score');
window.globalEnemies = [];

window.addEventListener('load', () => {
    ['background360', 'enemyVideo'].forEach(id=>{
        const vid = document.getElementById(id);
        if (vid) { vid.muted = true; vid.play().catch(()=>{}); }
    });
    const bg = document.getElementById('bgMusic');
    if (bg) { bg.volume = 0.25; bg.loop = true; bg.play().catch(()=>{}); }
});

/* ---------- Game state and score ---------- */
let spawnTimer = 0;
const spawnInterval = 1200;
let lastTime = performance.now();
let score = parseFloat(localStorage.getItem('tetrusScore') || '0');
scoreEl.textContent = `TIFFY Earnings: ${score.toFixed(6)}`;

function addScore(value){
    score += value;
    score = Math.round(score * 1e6) / 1e6;
    localStorage.setItem('tetrusScore', score.toString());
    scoreEl.textContent = `TIFFY Earnings: ${score.toFixed(6)}`;
}

function playSound(id, vol=1.0){
    const src = document.getElementById(id);
    if(!src) return;
    try{
        const node = src.cloneNode();
        node.volume = vol;
        node.play().catch(()=>{});
    }catch(e){}
}

/* ---------- Spawning enemies ---------- */
function spawnEnemy() {
    const cube = document.createElement('a-box');
    cube.setAttribute('material', 'src: #enemyVideo; repeat: 1 1; shader: standard; roughness: 0.8; metalness: 0.15');
    cube.setAttribute('width', 3);
    cube.setAttribute('height', 3);
    cube.setAttribute('depth', 3);
    cube.setAttribute('class', 'enemy');

    // Spawn on a random point on a sphere around the player
    const spawnRadius = 80;
    const theta = Math.random() * Math.PI * 2;
    const phi = Math.acos((Math.random() * 2) - 1);
    const x = spawnRadius * Math.sin(phi) * Math.cos(theta);
    const y = spawnRadius * Math.sin(phi) * Math.sin(theta);
    const z = spawnRadius * Math.cos(phi);
    
    const pos = new THREE.Vector3(x, y, z).add(camera.object3D.position);
    
    cube.object3D.position.copy(pos);
    scene.appendChild(cube);
    const rotSpeed = (Math.random() - 0.5) * 0.05;
    window.globalEnemies.push({el: cube, speed: 0.15 + Math.random() * 0.15, rotSpeed: rotSpeed});
    playSound('swoochSound', 0.45);
}

/* ---------- Explosion effect with flying pieces ---------- */
function explodeAt(position){
    const burst = document.createElement('a-entity');
    burst.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
    burst.setAttribute('particle-system', {
        preset: 'snow', particleCount: 400, color: '#ffdd99,#ffffff,#ff9933', size: 0.07,
        velocityValue: '1.2 1.6 1.2', spread: '1.5 1.5 1.5', duration: 0.85, blending: 2,
    });
    effectsParent.appendChild(burst);
    setTimeout(()=>{ if(burst.parentNode) burst.parentNode.removeChild(burst); }, 1000);

    const numPieces = 12 + Math.random() * 8;
    for(let i = 0; i < numPieces; i++){
        const piece = document.createElement('a-box');
        piece.setAttribute('width','0.3'); piece.setAttribute('height','0.3'); piece.setAttribute('depth','0.3');
        piece.setAttribute('material','color:#9a7f6c; metalness:0.1; roughness:0.8');
        piece.object3D.position.copy(position);
        effectsParent.appendChild(piece);

        const randDir = new THREE.Vector3((Math.random()*2-1),(Math.random()*1.4),(Math.random()*2-1)).normalize();
        const travel = 1.2 + Math.random()*1.8;
        const rotSpeed = (Math.random()*2 - 1) * 0.25;
        const duration = 600 + Math.random()*500;
        const start = performance.now();

        const animatePiece = (t)=>{
            const dt = (t - start) / duration;
            if(dt >= 1){
                if(piece.parentNode) piece.parentNode.removeChild(piece);
                return;
            }
            piece.object3D.position.copy(position).add(randDir.clone().multiplyScalar(travel * dt));
            piece.object3D.rotation.x += rotSpeed;
            piece.object3D.rotation.y += rotSpeed;
            requestAnimationFrame(animatePiece);
        };
        requestAnimationFrame(animatePiece);
    }
    playSound('explodeSound', 0.9);
}

// Function to create and launch the visual-only shot
function createVisualShot() {
    const start = camera.object3D.getWorldPosition(new THREE.Vector3());
    const forward = new THREE.Vector3();
    camera.object3D.getWorldDirection(forward);

    const visualShot = document.createElement('a-entity');
    visualShot.setAttribute('geometry', 'primitive: sphere; radius: 0.4');
    visualShot.setAttribute('material', 'shader: standard; emissive: #00ffff; emissiveIntensity: 2; metalness:0.05; roughness:0.2; transparent: true; opacity: 0.6');
    visualShot.setAttribute('visual-shot', 'direction', forward);
    visualShot.object3D.position.copy(start);

    const trail = document.createElement('a-entity');
    trail.setAttribute('particle-system', {
        preset: 'dust', particleCount: 200, color: '#00ffff,#88ffcc,#ffffff', size: 0.15,
        velocityValue: '0 0 0', spread: '0.22 0.22 0.22', duration: 0.6, blending: 2,
    });
    visualShot.appendChild(trail);
    effectsParent.appendChild(visualShot);
}

/* ---------- Main game loop ---------- */
function gameLoop(){
    const now = performance.now();
    const dt = now - lastTime;
    lastTime = now;

    spawnTimer += dt;
    if(spawnTimer > spawnInterval){
        spawnTimer = 0;
        spawnEnemy();
    }

    window.globalEnemies.forEach((e, i)=>{
        // Rotate the cubes like blocks flying
        e.el.object3D.rotation.x += e.rotSpeed * 0.8;
        e.el.object3D.rotation.y += e.rotSpeed;

        // Move forward
        const dir = new THREE.Vector3().subVectors(camera.object3D.position, e.el.object3D.position).normalize();
        e.el.object3D.position.add(dir.multiplyScalar(e.speed));

        // Make the cube bigger as it gets closer
        const distance = e.el.object3D.position.distanceTo(camera.object3D.position);
        const maxDistance = 150; 
        const scaleFactor = 1.0 + (1 - (distance / maxDistance)) * 1.5;
        e.el.object3D.scale.set(scaleFactor, scaleFactor, scaleFactor);

        // Enemy hit the player
        if(distance < 1.2){
            explodeAt(e.el.object3D.position.clone());
            if(e.el.parentNode) e.el.parentNode.removeChild(e.el);
            window.globalEnemies.splice(i,1);
        }
    });
    requestAnimationFrame(gameLoop);
}

/* ---------- SHOOTING LOGIC ---------- */
cursor.addEventListener('click', (e) => {
    playSound('shootSound', 0.9);
    createVisualShot();

    const intersection = e.detail.intersection;
    if (intersection && intersection.object && intersection.object.el && intersection.object.el.classList.contains('enemy')) {
        const enemyEl = intersection.object.el;
        const enemyPos = enemyEl.object3D.position;
        explodeAt(enemyPos.clone());
        if (enemyEl.parentNode) enemyEl.parentNode.removeChild(enemyEl);

        const index = window.globalEnemies.findIndex(item => item.el === enemyEl);
        if (index > -1) {
            window.globalEnemies.splice(index, 1);
        }
        addScore(0.002);
    }
});

/* ---------- Start the game ---------- */
lastTime = performance.now();
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
