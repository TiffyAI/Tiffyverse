<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>TiffyAI Arena</title>
  <style>
    body { margin: 0; overflow: hidden; background: black; }
    canvas { display: block; }
  </style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/jsm/controls/PointerLockControls.js"></script>
<script>
let scene, camera, renderer, controls;
let projectiles = [];
let enemies = [];
let score = 0;

// INIT
scene = new THREE.Scene();
camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 5000);
renderer = new THREE.WebGLRenderer({ antialias:true });
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// LIGHT
const hemi = new THREE.HemisphereLight(0xffffff, 0x444444, 1.2);
scene.add(hemi);

// VIDEO BACKGROUND
const video = document.createElement('video');
video.src = "https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/back.mp4";
video.loop = true;
video.muted = true;
video.play();

const videoTex = new THREE.VideoTexture(video);
const skyGeo = new THREE.BoxGeometry(4000, 4000, 4000);
const skyMat = new THREE.MeshBasicMaterial({ map: videoTex, side: THREE.BackSide });
const sky = new THREE.Mesh(skyGeo, skyMat);
scene.add(sky);

// GROUND (longer arena)
const groundGeo = new THREE.PlaneGeometry(4000, 4000, 10, 10);
const groundMat = new THREE.MeshPhongMaterial({ color:0x222222 });
const ground = new THREE.Mesh(groundGeo, groundMat);
ground.rotation.x = -Math.PI/2;
scene.add(ground);

// CONTROLS
controls = new THREE.PointerLockControls(camera, document.body);
document.body.addEventListener("click", ()=>controls.lock());
camera.position.y = 2;

// SHOOTING
window.addEventListener("click", shoot);

function shoot() {
  const geom = new THREE.SphereGeometry(0.2, 16, 16);
  const mat = new THREE.MeshBasicMaterial({ color: new THREE.Color(`hsl(${Math.random()*360},100%,50%)`) });
  const sphere = new THREE.Mesh(geom, mat);
  sphere.position.copy(camera.position);
  
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir);
  sphere.userData.vel = dir.multiplyScalar(2);
  projectiles.push(sphere);
  scene.add(sphere);
}

// ENEMIES
function spawnEnemy() {
  const geom = new THREE.BoxGeometry(2,2,2);
  const mat = new THREE.MeshPhongMaterial({ color:0xff0000, flatShading:true });
  const cube = new THREE.Mesh(geom, mat);

  // Spawn around the arena edges
  const side = Math.floor(Math.random()*4);
  const dist = 100 + Math.random()*200;
  if(side===0) cube.position.set(dist, 2, Math.random()*400-200);
  if(side===1) cube.position.set(-dist, 2, Math.random()*400-200);
  if(side===2) cube.position.set(Math.random()*400-200, 2, dist);
  if(side===3) cube.position.set(Math.random()*400-200, 2, -dist);

  cube.userData.vel = new THREE.Vector3((Math.random()-0.5)*0.3,0,(Math.random()-0.5)*0.3);
  enemies.push(cube);
  scene.add(cube);
}
setInterval(spawnEnemy, 1000);

// EXPLOSION PARTICLES
function explode(pos) {
  for(let i=0;i<30;i++){
    const geom = new THREE.SphereGeometry(0.1, 6, 6);
    const mat = new THREE.MeshBasicMaterial({ color: 0xffff00 });
    const p = new THREE.Mesh(geom, mat);
    p.position.copy(pos);
    p.userData.vel = new THREE.Vector3((Math.random()-0.5)*0.5,(Math.random()-0.5)*0.5,(Math.random()-0.5)*0.5);
    p.userData.life = 50;
    scene.add(p);
    projectiles.push(p);
  }
}

// LOOP
function animate() {
  requestAnimationFrame(animate);

  // Move projectiles
  for(let i=projectiles.length-1;i>=0;i--){
    const p = projectiles[i];
    p.position.add(p.userData.vel);
    if(p.userData.life!==undefined){
      p.userData.life--;
      if(p.userData.life<=0){ scene.remove(p); projectiles.splice(i,1); continue; }
    }
  }

  // Move enemies
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    e.position.add(e.userData.vel);

    // check hit by projectile
    for(let j=projectiles.length-1;j>=0;j--){
      const p = projectiles[j];
      if(e.position.distanceTo(p.position)<1.5){
        explode(e.position);
        scene.remove(e);
        enemies.splice(i,1);
        score += 0.002;
        console.log("Score:",score.toFixed(3),"TIFFY");
        break;
      }
    }
  }

  controls.moveRight(0); // keep controls active
  renderer.render(scene,camera);
}
animate();
</script>
</body>
</html>
