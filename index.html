<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Blockchain Storm AR-VR</title>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
<script src="https://cdn.jsdelivr.net/gh/IdeaSpaceVR/aframe-particle-system-component@1.0.0/dist/aframe-particle-system-component.min.js"></script>
<style>
Â  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
Â  html,body{height:100%;margin:0;background:#000;font-family:'Share Tech Mono',monospace;overflow:hidden;}

Â  /* Bottom HUD & handle */
Â  #hud-handle{
Â  Â  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
Â  Â  width:56px;height:18px;border-radius:12px 12px 0 0;
Â  Â  background:rgba(0,240,255,0.7);cursor:pointer;z-index:10001;
Â  Â  box-shadow:0 0 8px rgba(0,240,255,0.9);
Â  }
Â  #hud-strip{
Â  Â  position:fixed;bottom:-82px;left:50%;transform:translateX(-50%);
Â  Â  width:92%;max-width:520px;padding:8px 12px;border-radius:16px 16px 0 0;
Â  Â  display:flex;gap:8px;align-items:center;justify-content:space-around;
Â  Â  background:rgba(20,20,30,0.55);backdrop-filter:blur(12px);
Â  Â  border:1px solid rgba(0,240,255,0.35);box-shadow:0 0 12px rgba(0,240,255,0.45);
Â  Â  transition:bottom .35s ease;z-index:10000;
Â  }
Â  .hud-btn{
Â  Â  display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;
Â  Â  background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.22);
Â  Â  color:#00f0ff;font-size:14px;cursor:pointer;backdrop-filter:blur(6px);
Â  Â  transition:transform .18s ease,background .18s ease,border-color .18s ease;
Â  Â  user-select:none;
Â  }
Â  .hud-btn:hover{background:rgba(0,240,255,0.15);transform:translateY(-1px) scale(1.03);border-color:rgba(0,240,255,0.45);}
Â  .hud-btn:active{transform:scale(.98);}

Â  #balance{
Â  Â  display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:12px;
Â  Â  background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.18);
Â  Â  color:#00f0ff;font-size:14px;
Â  }
Â  #balance img{height:20px;filter:drop-shadow(0 0 5px rgba(0,240,255,0.8));}

Â  /* Challenge bar */
Â  #challenge{
Â  Â  position:fixed;bottom:92px;left:50%;transform:translateX(-50%);
Â  Â  width:92%;max-width:520px;background:rgba(20,20,30,0.5);border-radius:12px;
Â  Â  padding:8px 10px;border:1px solid rgba(0,240,255,0.35);box-shadow:0 0 10px rgba(0,240,255,0.35);
Â  Â  font-family:'Share Tech Mono',monospace;color:#00f0ff;font-size:13px;z-index:10000;
Â  Â  backdrop-filter:blur(8px);
Â  }
Â  #challenge-bar{width:100%;height:12px;background:rgba(255,255,255,0.08);border-radius:8px;overflow:hidden;margin-top:6px;}
Â  #challenge-fill{height:100%;width:0%;background:linear-gradient(90deg,#00f0ff,#00ff99);transition:width .35s ease;}

Â  #online{margin-top:8px;font-size:12px;opacity:.9;}

Â  /* Popup */
Â  #congrats{
Â  Â  display:none;position:fixed;inset:0;background:rgba(3,6,15,0.94);z-index:20000;
Â  Â  align-items:center;justify-content:center;padding:20px;color:#00f0ff;font-family:'Share Tech Mono',monospace;
Â  }
Â  #congrats .card{
Â  Â  background:rgba(0,0,0,0.7);border:2px solid #00f0ff;border-radius:16px;padding:20px;
Â  Â  box-shadow:0 0 20px #00f0ff;text-align:center;max-width:92%;
Â  }
Â  #congrats h1{font-size:22px;margin:0 0 8px;color:#00ffcc;}
Â  #congrats p{margin:6px 0;font-size:15px;}
Â  #congrats b{color:#fff;}
Â  /* make sure UI clickable */
Â  #hud-strip,#hud-handle,#congrats{pointer-events:auto;}
</style>
</head>
<body>

<a-scene vr-mode-ui="enabled: true">
Â  <a-assets>
Â  Â  Â  Â  <video id="rightVideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/main/assets/right.mp4"></video>
Â  Â  <video id="topVideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/main/assets/top.mp4"></video>
Â  Â  <video id="leftVideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/main/assets/left.mp4"></video>
Â  Â  <video id="bottomVideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/main/assets/bottom.mp4"></video>
Â  Â  <video id="backVideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/main/assets/back.mp4"></video>
Â  Â  <video id="enemyVideo" autoplay loop muted playsinline crossorigin="anonymous" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/enemies.mp4"></video>

Â  Â  Â  Â  <audio id="shootSound" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/fire.wav"></audio>
Â  Â  <audio id="explodeSound" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/blocks.wav"></audio>
Â  Â  <audio id="swoochSound" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/swooch.wav"></audio>
Â  Â  <audio id="bgMusic" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/playing.wav" crossorigin="anonymous"></audio>
Â  Â  <audio id="clickSound" src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/click.wav"></audio>
Â  </a-assets>

Â  <a-sky id="sky" src="#rightVideo"></a-sky>

Â  <a-entity id="player" camera look-controls wasd-controls position="0 1.6 0"></a-entity>

Â  <a-entity id="cursor" cursor="fuse:false; rayOrigin: mouse"
Â  Â  Â  Â  Â  Â  position="0 0 -1"
Â  Â  Â  Â  Â  Â  geometry="primitive:ring; radiusInner:0.02; radiusOuter:0.03"
Â  Â  Â  Â  Â  Â  material="color: #00ffff; shader: flat"
Â  Â  Â  Â  Â  Â  animation="property: scale; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 400"
Â  Â  Â  Â  Â  Â  raycaster="objects: .enemy; far: 200"></a-entity>

Â  <a-entity id="effects-parent"></a-entity>
</a-scene>

<div id="hud-handle" title="Open controls"></div>
<div id="hud-strip">
Â  <div id="balance"><img src="https://tiffyai.github.io/TiffyAI-Token.png" alt="TIFFY">0.000000</div>
Â  <div class="hud-btn" id="btn-ar">ğŸŒ AR</div>
Â  <div class="hud-btn" id="btn-vr">ğŸ•¶ï¸ VR</div>
Â  <div class="hud-btn" id="btn-withdraw">ğŸ’¸ Withdraw</div>
</div>

<div id="challenge">
Â  <div id="challenge-label">Storm Challenge (50 TIFFY)</div>
Â  <div id="challenge-bar"><div id="challenge-fill"></div></div>
Â  <div id="online">ğŸŒ 0 players online</div>
</div>

<div id="congrats">
Â  <div class="card">
Â  Â  <h1>ğŸš€ Spectacular Congratulations! ğŸš€</h1>
Â  Â  <p>Withdraw Now & Enter the 7 Day Challenge!</p>
Â  Â  <p>WIN an additional <b>100 TIFFY Tokens</b>.</p>
Â  Â  <p>The first 10 players get 100 TIFFY and the winner takes <b>200 scarce TIFFY gems</b>.</p>
Â  Â  <p id="timestamp"></p>
Â  </div>
</div>

<script>
/* ---------- Components & Globals ---------- */
AFRAME.registerComponent('visual-shot', {
Â  schema: { direction: {type:'vec3'}, speed: {type:'number', default:150} },
Â  tick: function (time, dt) {
Â  Â  const mv = this.data.direction.clone().multiplyScalar(this.data.speed * dt / 1000);
Â  Â  this.el.object3D.position.add(mv);
Â  Â  const cam = document.getElementById('player').object3D.position;
Â  Â  if (this.el.object3D.position.distanceTo(cam) > 200) {
Â  Â  Â  this.el.parentNode && this.el.parentNode.removeChild(this.el);
Â  Â  }
Â  }
});

const scene = document.querySelector('a-scene');
const sky = document.getElementById('sky');
const player = document.getElementById('player');
const cursor = document.getElementById('cursor');
const effectsParent = document.getElementById('effects-parent');

const hudHandle = document.getElementById('hud-handle');
const hudStrip = document.getElementById('hud-strip');
const balanceEl = document.getElementById('balance');
const challengeFill = document.getElementById('challenge-fill');
const onlineEl = document.getElementById('online');
const congratsEl = document.getElementById('congrats');
const timestampEl = document.getElementById('timestamp');
const withdrawBtn = document.getElementById('btn-withdraw');

let hudOpen = false;

// The game's progress bar is now separate from the total score
const PROGRESS_THRESHOLD_TIFFY = 50; // The threshold to fill the bar
let cubesDestroyedInSession = 0;

/* Score synchronized to tetrusScore */
let score = parseFloat(localStorage.getItem('tetrusScore') || '0');

/* Helper: play sound clone */
function playSound(id, vol=1.0){
Â  const src = document.getElementById(id);
Â  if(!src) return;
Â  try{
Â  Â  const n = src.cloneNode(true);
Â  Â  n.volume = vol;
Â  Â  n.play().catch(()=>{});
Â  }catch(e){}
}

/* Update HUD balance & challenge visuals */
function renderBalance(){
Â  balanceEl.innerHTML = `<img src="https://tiffyai.github.io/TiffyAI-Token.png" alt="TIFFY">${score.toFixed(6)}`;
}

/* Updated logic for the challenge bar */
function renderChallenge(){
Â  // Check if the score has been withdrawn (local storage is 0) to reset the bar
Â  if (localStorage.getItem('tetrusScore') === '0'){
Â  Â  cubesDestroyedInSession = 0;
Â  }
Â  
Â  // Progress is based on cubes destroyed this session
Â  const cubesPerTiffy = 1 / 0.002;
Â  const cubesForGoal = PROGRESS_THRESHOLD_TIFFY * cubesPerTiffy;
Â  const progress = Math.min(cubesDestroyedInSession / cubesForGoal, 1);
Â  challengeFill.style.width = (progress * 100) + '%';
Â  
Â  // If the bar is full and the user's score in local storage is NOT 0, show congrats.
Â  // This means they haven't withdrawn yet.
Â  if (progress >= 1 && score > 0){
Â  Â  onThresholdReached();
Â  }
}

/* threshold behavior */
function onThresholdReached(){
Â  playSound('clickSound', 0.95);
Â  const now = new Date();
Â  timestampEl.textContent = 'â± Threshold reached: ' + now.toLocaleString();
Â  congratsEl.style.display = 'flex';
Â  
Â  // Show popup for 30 seconds, then redirect
Â  setTimeout(() => {
Â  Â  window.open('https://tiffyai.github.io/Offline-', '_self');
Â  }, 30000); // 30 seconds
}

/* Updated addScore is the single source of truth called when cubes are destroyed */
function addScore(value){
Â  score += value;
Â  // safe rounding digit-by-digit
Â  score = Math.round(score * 1e6) / 1e6;
Â  localStorage.setItem('tetrusScore', score.toString());
Â  cubesDestroyedInSession++; // Track cubes destroyed for progress bar
Â  renderBalance();
Â  renderChallenge();
}

/* ---------- Enemy / game logic (spawn, explode, shots) ---------- */
let spawnTimer = 0;
const spawnInterval = 1200;
let lastTime = performance.now();
window.globalEnemies = [];

function spawnEnemy(){
Â  const cube = document.createElement('a-box');
Â  cube.setAttribute('material', 'src: #enemyVideo; repeat: 1 1; shader: standard; roughness: 0.8; metalness: 0.15');
Â  cube.setAttribute('width', 3); cube.setAttribute('height', 3); cube.setAttribute('depth', 3);
Â  cube.setAttribute('class', 'enemy');

Â  const spawnDistance = 80;
Â  const horizontalRange = 50;
Â  const verticalRange = 30;

Â  const randX = (Math.random() - 0.5) * 2 * horizontalRange;
Â  const randY = (Math.random() - 0.5) * 2 * verticalRange;
Â  const localPos = new THREE.Vector3(randX, randY, -spawnDistance);

Â  const q = new THREE.Quaternion();
Â  player.object3D.getWorldQuaternion(q);
Â  const playerPos = new THREE.Vector3();
Â  player.object3D.getWorldPosition(playerPos);

Â  localPos.applyQuaternion(q);
Â  const worldPos = playerPos.clone().add(localPos);

Â  cube.object3D.position.copy(worldPos);
Â  scene.appendChild(cube);

Â  const rotSpeed = (Math.random() - 0.5) * 0.05;
Â  window.globalEnemies.push({el: cube, speed: 0.15 + Math.random()*0.15, rotSpeed});
Â  playSound('swoochSound', 0.45);
}

function explodeAt(position){
Â  const burst = document.createElement('a-entity');
Â  burst.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
Â  burst.setAttribute('particle-system', {
Â  Â  preset:'snow', particleCount:400, color:'#ffdd99,#ffffff,#ff9933', size:0.07,
Â  Â  velocityValue:'1.2 1.6 1.2', spread:'1.5 1.5 1.5', duration:0.85, blending:2
Â  });
Â  effectsParent.appendChild(burst);
Â  setTimeout(()=>{ burst.parentNode && burst.parentNode.removeChild(burst); }, 1000);

Â  const numPieces = 12 + Math.random()*8;
Â  for (let i=0;i<numPieces;i++){
Â  Â  const piece = document.createElement('a-box');
Â  Â  piece.setAttribute('width','0.3'); piece.setAttribute('height','0.3'); piece.setAttribute('depth','0.3');
Â  Â  piece.setAttribute('material','color:#9a7f6c; metalness:0.1; roughness:0.8');
Â  Â  piece.object3D.position.copy(position);
Â  Â  effectsParent.appendChild(piece);

Â  Â  const randDir = new THREE.Vector3((Math.random()*2-1),(Math.random()*1.4),(Math.random()*2-1)).normalize();
Â  Â  const travel = 1.2 + Math.random()*1.8;
Â  Â  const rot = (Math.random()*2 - 1) * 0.25;
Â  Â  const duration = 600 + Math.random()*500;
Â  Â  const start = performance.now();
Â  Â  const animatePiece = (t) => {
Â  Â  Â  const dt = (t - start) / duration;
Â  Â  Â  if (dt >= 1){ piece.parentNode && piece.parentNode.removeChild(piece); return; }
Â  Â  Â  piece.object3D.position.copy(position).add(randDir.clone().multiplyScalar(travel * dt));
Â  Â  Â  piece.object3D.rotation.x += rot; piece.object3D.rotation.y += rot;
Â  Â  Â  requestAnimationFrame(animatePiece);
Â  Â  };
Â  Â  requestAnimationFrame(animatePiece);
Â  }
Â  playSound('explodeSound', 0.9);
}

function createVisualShot(){
Â  const start = player.object3D.getWorldPosition(new THREE.Vector3());
Â  const forward = new THREE.Vector3(); player.object3D.getWorldDirection(forward);

Â  const shot = document.createElement('a-entity');
Â  shot.setAttribute('geometry','primitive:sphere;radius:0.4');
Â  shot.setAttribute('material','shader:standard;emissive:#00ffff;emissiveIntensity:2;metalness:0.05;roughness:0.2;transparent:true;opacity:0.6');
Â  shot.setAttribute('visual-shot','direction',forward);
Â  shot.object3D.position.copy(start);

Â  const trail = document.createElement('a-entity');
Â  trail.setAttribute('particle-system',{
Â  Â  preset:'dust', particleCount:200, color:'#00ffff,#88ffcc,#ffffff', size:0.15,
Â  Â  velocityValue:'0 0 0', spread:'0.22 0.22 0.22', duration:0.6, blending:2
Â  });
Â  shot.appendChild(trail);
Â  effectsParent.appendChild(shot);
}

/* Main loop */
function gameLoop(){
Â  const now = performance.now();
Â  const dt = now - lastTime;
Â  lastTime = now;

Â  spawnTimer += dt;
Â  if (spawnTimer > spawnInterval){ spawnTimer = 0; spawnEnemy(); }

Â  for (let i = window.globalEnemies.length - 1; i >= 0; i--){
Â  Â  const e = window.globalEnemies[i];
Â  Â  e.el.object3D.rotation.x += e.rotSpeed * 0.8;
Â  Â  e.el.object3D.rotation.y += e.rotSpeed;

Â  Â  const dir = new THREE.Vector3().subVectors(player.object3D.position, e.el.object3D.position).normalize();
Â  Â  e.el.object3D.position.add(dir.multiplyScalar(e.speed));

Â  Â  const distance = e.el.object3D.position.distanceTo(player.object3D.position);
Â  Â  const maxDistance = 150;
Â  Â  const scaleFactor = 1.0 + (1 - (distance / maxDistance)) * 1.5;
Â  Â  e.el.object3D.scale.set(scaleFactor, scaleFactor, scaleFactor);

Â  Â  if (distance < 1.2){
Â  Â  Â  explodeAt(e.el.object3D.position.clone());
Â  Â  Â  e.el.parentNode && e.el.parentNode.removeChild(e.el);
Â  Â  Â  window.globalEnemies.splice(i,1);
Â  Â  }
Â  }
Â  requestAnimationFrame(gameLoop);
}

/* Shooting & clicking */
cursor.addEventListener('click', (e) => {
Â  playSound('shootSound', 0.9);
Â  createVisualShot();

Â  const inter = e.detail.intersection;
Â  if (inter && inter.object && inter.object.el){
Â  Â  const clickedEl = inter.object.el;
Â  Â  if (clickedEl.classList.contains('enemy')){
Â  Â  Â  const enemyPos = clickedEl.object3D.position;
Â  Â  Â  explodeAt(enemyPos.clone());
Â  Â  Â  clickedEl.parentNode && clickedEl.parentNode.removeChild(clickedEl);
Â  Â  Â  const index = window.globalEnemies.findIndex(it => it.el === clickedEl);
Â  Â  Â  if (index > -1) window.globalEnemies.splice(index,1);

Â  Â  Â  // award score for destroying cube (keeps tetrusScore synchronized)
Â  Â  Â  addScore(0.002);
Â  Â  }
Â  }
});

/* Stage change */
const stages = [
Â  { videoId: 'rightVideo', rotation: '0 -90 0' },
Â  { videoId: 'topVideo', rotation: '90 0 0' },
Â  { videoId: 'leftVideo', rotation: '0 90 0' },
Â  { videoId: 'bottomVideo', rotation: '-90 0 0' },
Â  { videoId: 'backVideo', rotation: '0 180 0' }
];
let currentStageIndex = 0;
function nextStage(){
Â  currentStageIndex = (currentStageIndex + 1) % stages.length;
Â  const s = stages[currentStageIndex];
Â  sky.setAttribute('src', `#${s.videoId}`);
Â  player.setAttribute('rotation', s.rotation);
Â  console.log('Stage changed:', s.videoId);
}

/* ---------- HUD actions ---------- */
hudHandle.addEventListener('click', () => {
Â  hudOpen = !hudOpen;
Â  hudStrip.style.bottom = hudOpen ? '0' : '-82px';
Â  playSound('clickSound', 0.85);
});
withdrawBtn.addEventListener('click', () => {
Â  playSound('clickSound', 0.95);
Â  // When the user clicks withdraw, we reset the local storage score to 0
Â  localStorage.setItem('tetrusScore', '0');
Â  // Redirect to the withdraw page
Â  window.open('https://tiffyai.github.io/Offline-', '_self');
});
document.getElementById('btn-vr').addEventListener('click', async () => {
Â  playSound('clickSound', 0.9);
Â  try{ await scene.enterVR(); } catch(e){ console.log('VR not available',e); }
});
document.getElementById('btn-ar').addEventListener('click', async () => {
Â  playSound('click-sound', 0.9);
Â  try {
Â  Â  if (!scene.hasAttribute('webxr')) scene.setAttribute('webxr','mode: ar');
Â  Â  await scene.enterVR();
Â  } catch(e){ console.log('AR not available', e); }
});

/* ---------- Online counter (mocked) ---------- */
function updateOnline(){
Â  const fake = 20 + Math.floor(Math.random() * 120);
Â  onlineEl.textContent = 'ğŸŒ ' + fake + ' players online';
}
setInterval(updateOnline, 5000);
updateOnline();

/* ---------- Boot ---------- */
window.addEventListener('load', () => {
Â  // Start videos & music safely
Â  ['rightVideo','topVideo','leftVideo','bottomVideo','backVideo','enemyVideo'].forEach(id=>{
Â  Â  const v = document.getElementById(id);
Â  Â  if (v){ v.muted = true; v.play().catch(()=>{}); }
Â  });
Â  const bg = document.getElementById('bgMusic');
Â  if (bg){ bg.volume = 0.25; bg.loop = true; bg.play().catch(()=>{}); }

Â  // load score from storage & render
Â  score = parseFloat(localStorage.getItem('tetrusScore') || '0');
Â  renderBalance();
Â  
Â  // Call renderChallenge to check the initial state of the progress bar
Â  renderChallenge();

Â  lastTime = performance.now();
Â  requestAnimationFrame(gameLoop);
});
</script>
</body>
</html>
