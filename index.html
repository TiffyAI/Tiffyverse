<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TiffyAI Block Defense</title>
  <script src="https://aframe.io/releases/1.4.1/aframe.min.js"></script>
  <style>
    #scoreBoard {
      position: absolute;
      top: 15px;
      left: 15px;
      font-size: 22px;
      font-family: monospace;
      color: #00ffe0;
      background: rgba(0,0,0,0.5);
      padding: 6px 12px;
      border-radius: 6px;
    }
  </style>
</head>
<body>
  <div id="scoreBoard">Score: 0.000 TIFFY</div>
  <a-scene>
    <!-- Background -->
    <a-videosphere src="back.mp4" rotation="0 -90 0"></a-videosphere>

    <!-- Player -->
    <a-entity id="player" position="0 1.6 0" camera look-controls wasd-controls></a-entity>

    <!-- Floor + Ceiling (wider area) -->
    <a-plane rotation="-90 0 0" width="200" height="200" color="#222"></a-plane>
    <a-plane rotation="90 0 0" position="0 50 0" width="200" height="200" color="#111"></a-plane>

    <!-- Sounds -->
    <a-assets>
      <audio id="shoot-sound" src="fire.wav"></audio>
      <audio id="explode-sound" src="blocks.wav"></audio>
      <audio id="swoosh-sound" src="swooch.wav"></audio>
      <audio id="bg-music" src="playing.wav" preload="auto"></audio>
    </a-assets>

    <a-entity sound="src: #bg-music; autoplay: true; loop: true; volume: 0.4"></a-entity>
  </a-scene>

  <script>
    const scene = document.querySelector("a-scene");
    const player = document.getElementById("player");
    const scoreBoard = document.getElementById("scoreBoard");
    let score = 0;

    // ðŸŽ¯ Shoot glowing projectile
    window.addEventListener("click", () => {
      const proj = document.createElement("a-sphere");
      proj.setAttribute("radius", "0.1");
      proj.setAttribute("position", player.getAttribute("position"));
      proj.setAttribute("color", "#ff00ff");
      proj.setAttribute("material", "emissive: #ff00ff; emissiveIntensity: 2; shader: standard");

      // glowing trail
      proj.setAttribute("particle-system", {
        preset: "dust",
        color: "#ff00ff, #00ffff",
        size: 0.2,
        opacity: 0.8,
        particleCount: 50
      });

      // movement
      const dir = new THREE.Vector3();
      player.object3D.getWorldDirection(dir);
      proj.bodyVel = dir.multiplyScalar(-0.6); // forward

      scene.appendChild(proj);

      // sound
      const s = document.createElement("a-entity");
      s.setAttribute("sound", "src: #shoot-sound; autoplay: true; volume: 0.8");
      proj.appendChild(s);

      // animate
      proj.tick = () => {
        const p = proj.getAttribute("position");
        proj.setAttribute("position", {
          x: p.x + proj.bodyVel.x * 5,
          y: p.y + proj.bodyVel.y * 5,
          z: p.z + proj.bodyVel.z * 5
        });

        // remove if too far
        if (Math.abs(p.x) > 100 || Math.abs(p.z) > 100) {
          scene.removeChild(proj);
        }

        // check collision with enemies
        document.querySelectorAll(".enemy").forEach(enemy => {
          const ep = enemy.getAttribute("position");
          if (ep && p.distanceTo(ep) < 1) {
            explodeEnemy(enemy);
            scene.removeChild(proj);
          }
        });
      };
    });

    // ðŸ§± Spawn enemies all around
    function spawnEnemy() {
      const e = document.createElement("a-box");
      const side = Math.floor(Math.random() * 4); // 0 front, 1 back, 2 left, 3 right
      const dist = 60;
      let x=0, y=Math.random()*6+1, z=0;

      if (side === 0) z = -dist; 
      if (side === 1) z = dist; 
      if (side === 2) x = -dist; 
      if (side === 3) x = dist; 

      e.setAttribute("position", {x, y, z});
      e.setAttribute("depth", 2);
      e.setAttribute("height", 2);
      e.setAttribute("width", 2);
      e.setAttribute("color", "#666");
      e.setAttribute("class", "enemy");

      // rotation + movement
      const dir = new THREE.Vector3(-x, -y+1.6, -z).normalize().multiplyScalar(0.1);
      e.bodyVel = dir;

      // spin randomly
      e.rotVel = {
        x: (Math.random()-0.5)*2,
        y: (Math.random()-0.5)*2,
        z: (Math.random()-0.5)*2
      };

      // swoosh sound
      const s = document.createElement("a-entity");
      s.setAttribute("sound", "src: #swoosh-sound; autoplay: true; volume: 0.6");
      e.appendChild(s);

      // tick
      e.tick = () => {
        const p = e.getAttribute("position");
        e.setAttribute("position", {
          x: p.x + e.bodyVel.x,
          y: p.y + e.bodyVel.y,
          z: p.z + e.bodyVel.z
        });
        e.object3D.rotation.x += e.rotVel.x * 0.05;
        e.object3D.rotation.y += e.rotVel.y * 0.05;
        e.object3D.rotation.z += e.rotVel.z * 0.05;

        // check hit player
        const pp = player.getAttribute("position");
        if (p.distanceTo(pp) < 1.5) {
          explodeEnemy(e);
        }
      };

      scene.appendChild(e);
    }

    // ðŸ’¥ Enemy explosion
    function explodeEnemy(enemy) {
      if (!enemy.parentNode) return;

      const pos = enemy.getAttribute("position");
      for (let i = 0; i < 10; i++) {
        const part = document.createElement("a-box");
        part.setAttribute("color", "#ff4444");
        part.setAttribute("depth", 0.3);
        part.setAttribute("height", 0.3);
        part.setAttribute("width", 0.3);
        part.setAttribute("position", pos);
        scene.appendChild(part);

        const vel = {
          x: (Math.random()-0.5)*0.8,
          y: (Math.random()-0.5)*0.8,
          z: (Math.random()-0.5)*0.8
        };

        part.tick = () => {
          const p = part.getAttribute("position");
          part.setAttribute("position", {
            x: p.x + vel.x,
            y: p.y + vel.y,
            z: p.z + vel.z
          });
          part.setAttribute("opacity", (part.getAttribute("opacity")||1) - 0.02);
          if (part.getAttribute("opacity") <= 0) scene.removeChild(part);
        };
      }

      // play sound
      const s = document.createElement("a-entity");
      s.setAttribute("sound", "src: #explode-sound; autoplay: true; volume: 1");
      enemy.appendChild(s);

      // remove enemy
      scene.removeChild(enemy);

      // score
      score += 0.002;
      scoreBoard.innerText = "Score: " + score.toFixed(3) + " TIFFY";
    }

    // ðŸŽ² Game loop
    function gameTick() {
      document.querySelectorAll("a-scene a-entity").forEach(ent => {
        if (ent.tick) ent.tick();
      });
      requestAnimationFrame(gameTick);
    }
    gameTick();

    // spawn waves
    setInterval(() => {
      for (let i = 0; i < 5; i++) spawnEnemy();
    }, 2000);
  </script>
</body>
</html>
