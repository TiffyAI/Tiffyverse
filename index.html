<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TiffyAI AR Shooter</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <style>
    body, html {
      margin:0;
      padding:0;
      height:100%;
      overflow:hidden;
      background:black;
    }
  </style>
</head>
<body>
  <a-scene embedded vr-mode-ui="enabled: true">

    <!-- Assets -->
    <a-assets>
      <video id="frontVideo" autoplay loop muted playsinline crossorigin="anonymous" src="front.mp4"></video>
      <video id="backVideo" autoplay loop muted playsinline crossorigin="anonymous" src="back.mp4"></video>
      <video id="leftVideo" autoplay loop muted playsinline crossorigin="anonymous" src="left.mp4"></video>
      <video id="rightVideo" autoplay loop muted playsinline crossorigin="anonymous" src="right.mp4"></video>
      <video id="topVideo" autoplay loop muted playsinline crossorigin="anonymous" src="top.mp4"></video>
      <video id="bottomVideo" autoplay loop muted playsinline crossorigin="anonymous" src="bottom.mp4"></video>

      <video id="orbVideo" autoplay loop muted playsinline src="orb.mp4"></video>
      <video id="enemyVideo" autoplay loop muted playsinline src="enemies.mp4"></video>
    </a-assets>

    <!-- Skybox cube using planes -->
    <a-plane src="#frontVideo" position="0 1.6 -50" rotation="0 0 0" width="100" height="100"></a-plane>
    <a-plane src="#backVideo" position="0 1.6 50" rotation="0 180 0" width="100" height="100"></a-plane>
    <a-plane src="#leftVideo" position="-50 1.6 0" rotation="0 90 0" width="100" height="100"></a-plane>
    <a-plane src="#rightVideo" position="50 1.6 0" rotation="0 -90 0" width="100" height="100"></a-plane>
    <a-plane src="#topVideo" position="0 101.6 0" rotation="90 0 0" width="150" height="150"></a-plane>
    <a-plane src="#bottomVideo" position="0 -48.4 0" rotation="-90 0 0" width="100" height="100"></a-plane>

    <!-- Camera with cursor for shooting -->
    <a-entity id="player" camera look-controls position="0 1.6 0">
      <a-entity cursor="fuse: false; rayOrigin: mouse"
                position="0 0 -1"
                geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.02"
                material="color: #00f0ff; shader: flat">
      </a-entity>
    </a-entity>

  </a-scene>

  <script>
    const scene = document.querySelector('a-scene');
    const camera = document.getElementById('player');

    const orbs = [];
    const enemies = [];

    // Helper: create orb entity
    function shootOrb() {
      const orb = document.createElement('a-video');
      orb.setAttribute('src', '#orbVideo');
      orb.setAttribute('width', '1');
      orb.setAttribute('height', '1');
      orb.setAttribute('position', camera.getAttribute('position'));
      orb.object3D.position.z -= 1; // in front of camera
      scene.appendChild(orb);

      const direction = new THREE.Vector3();
      camera.object3D.getWorldDirection(direction);

      orbs.push({el: orb, dir: direction, speed: 1});
    }

    // Helper: spawn enemy at random back/left/right
    function spawnEnemy() {
      const enemy = document.createElement('a-video');
      enemy.setAttribute('src', '#enemyVideo');
      enemy.setAttribute('width', '2');
      enemy.setAttribute('height', '2');

      const pos = {x: 0, y: 1.6, z: -30}; // start behind camera
      const side = Math.floor(Math.random() * 3);
      if(side===0) pos.x = -40;   // left
      if(side===1) pos.x = 40;    // right
      if(side===2) pos.z = -50;   // back

      enemy.setAttribute('position', pos);
      scene.appendChild(enemy);

      const direction = new THREE.Vector3();
      direction.subVectors(camera.object3D.position, new THREE.Vector3(pos.x,pos.y,pos.z)).normalize();

      enemies.push({el: enemy, dir: direction, speed: 0.1 + Math.random()*0.1});
    }

    // Move orbs and enemies
    function gameLoop() {
      for(let i=orbs.length-1;i>=0;i--){
        const o = orbs[i];
        o.el.object3D.position.addScaledVector(o.dir, o.speed);
      }

      for(let i=enemies.length-1;i>=0;i--){
        const e = enemies[i];
        e.el.object3D.position.addScaledVector(e.dir, e.speed);
      }

      requestAnimationFrame(gameLoop);
    }

    // Tap or click to shoot
    window.addEventListener('click', shootOrb);

    // Spawn enemies every 3s
    setInterval(spawnEnemy, 3000);

    // Start loop
    gameLoop();

    // Ensure all videos play on mobile
    window.addEventListener('load', () => {
      ['frontVideo','backVideo','leftVideo','rightVideo','topVideo','bottomVideo','orbVideo','enemyVideo'].forEach(id => {
        const vid = document.getElementById(id);
        vid.muted = true;
        vid.play().catch(err => console.warn(`${id} autoplay blocked`, err));
      });
    });
  </script>
</body>
</html>
