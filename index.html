<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>TiffyAI AR Shooter</title>
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe-particle-system-component@v1.0.0/dist/aframe-particle-system-component.min.js"></script>
  <style>
    body, html {
      margin:0; padding:0; height:100%; overflow:hidden; background:black;
      font-family: monospace;
    }
  </style>
</head>
<body>

<a-scene background="color: black">

  <!-- Assets -->
  <a-assets>
    <video id="frontVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/front.mp4"></video>
    <video id="backVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/back.mp4"></video>
    <video id="leftVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/left.mp4"></video>
    <video id="rightVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/right.mp4"></video>
    <video id="topVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/top.mp4"></video>
    <video id="bottomVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/bottom.mp4"></video>

    <video id="orbVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/orb.webm"></video>
    <video id="enemyVideo" autoplay loop muted playsinline crossorigin="anonymous"
      src="https://raw.githubusercontent.com/TiffyAI/Tiffyverse/refs/heads/main/assets/enemies.webm"></video>
  </a-assets>

  <!-- Environment planes -->
  <a-plane src="#frontVideo" position="0 1.6 -50" rotation="0 0 0" width="100" height="100"></a-plane>
  <a-plane src="#backVideo" position="0 1.6 50" rotation="0 180 0" width="100" height="100"></a-plane>
  <a-plane src="#leftVideo" position="-50 1.6 0" rotation="0 90 0" width="100" height="100"></a-plane>
  <a-plane src="#rightVideo" position="50 1.6 0" rotation="0 -90 0" width="100" height="100"></a-plane>
  <a-plane src="#topVideo" position="0 101.6 0" rotation="90 0 0" width="150" height="150"></a-plane>
  <a-plane src="#bottomVideo" position="0 -48.4 0" rotation="-90 0 0" width="100" height="100"></a-plane>

  <!-- Player camera -->
  <a-entity id="player" camera look-controls wasd-controls position="0 1.6 0"></a-entity>
</a-scene>

<script>
  const scene = document.querySelector('a-scene');
  const camera = document.getElementById('player');

  const enemies = [];
  const orbs = [];

  // Play all videos on mobile
  window.addEventListener('load', () => {
    ['frontVideo','backVideo','leftVideo','rightVideo','topVideo','bottomVideo','orbVideo','enemyVideo'].forEach(id => {
      const vid = document.getElementById(id);
      vid.muted = true;
      vid.play().catch(err => console.warn(`Autoplay blocked for ${id}:`, err));
    });
  });

  // Shoot orb from camera forward
  function shootOrb() {
    const orb = document.createElement('a-video');
    orb.setAttribute('src','#orbVideo');
    orb.setAttribute('width','1.5');
    orb.setAttribute('height','1.5');
    orb.setAttribute('transparent','true');

    const camPos = camera.object3D.position.clone();
    orb.object3D.position.copy(camPos);

    // Get forward direction
    const dir = new THREE.Vector3();
    camera.object3D.getWorldDirection(dir);

    scene.appendChild(orb);
    orbs.push({el: orb, dir: dir.clone()});

    // Particle trail
    const trail = document.createElement('a-entity');
    trail.setAttribute('particle-system',{
      preset:'dust',
      particleCount:50,
      color:'#00ffff,#ffffff',
      size:0.1,
      velocityValue:'0 0 0',
      duration:0.2
    });
    orb.appendChild(trail);
  }

  // Spawn enemy from back, left, or right
  function spawnEnemy() {
    const enemy = document.createElement('a-video');
    enemy.setAttribute('src','#enemyVideo');
    enemy.setAttribute('width','2');
    enemy.setAttribute('height','2');
    enemy.setAttribute('transparent','true');

    const side = Math.floor(Math.random()*3);
    const pos = new THREE.Vector3();
    if(side===0) pos.set(Math.random()*20-10, 1.6, 20);        // back
    else if(side===1) pos.set(-15, 1.6, Math.random()*20-10);  // left
    else pos.set(15, 1.6, Math.random()*20-10);                // right

    enemy.object3D.position.copy(pos);
    scene.appendChild(enemy);
    enemies.push({el: enemy, side, speed: 0.2 + Math.random()*0.2});
  }

  // Collision detection
  function isColliding(a,b){
    return a.object3D.position.distanceTo(b.object3D.position) < 1.0;
  }

  // Game loop
  function gameLoop() {
    // Move enemies
    enemies.forEach((e,i)=>{
      const dir = new THREE.Vector3();
      dir.subVectors(camera.object3D.position, e.el.object3D.position).normalize();
      e.el.object3D.position.add(dir.multiplyScalar(e.speed));

      if(e.el.object3D.position.distanceTo(camera.object3D.position)<0.5){
        e.el.remove();
        enemies.splice(i,1);
      }
    });

    // Move orbs
    orbs.forEach((o,i)=>{
      o.el.object3D.position.add(o.dir.clone().multiplyScalar(0.5));

      // Check collisions
      enemies.forEach((e,j)=>{
        if(isColliding(o.el,e.el)){
          // Explosion
          const explosion = document.createElement('a-sphere');
          explosion.setAttribute('position',e.el.getAttribute('position'));
          explosion.setAttribute('radius',1);
          explosion.setAttribute('color','#00ffff');
          scene.appendChild(explosion);
          setTimeout(()=>explosion.remove(),300);

          e.el.remove();
          enemies.splice(j,1);
          o.el.remove();
          orbs.splice(i,1);
        }
      });

      // Remove if too far
      if(o.el.object3D.position.distanceTo(camera.object3D.position)>50){
        o.el.remove();
        orbs.splice(i,1);
      }
    });

    requestAnimationFrame(gameLoop);
  }

  // Input
  window.addEventListener('click', shootOrb);
  setInterval(spawnEnemy, 2000);
  gameLoop();
</script>

</body>
</html>
